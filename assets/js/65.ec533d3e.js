(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{427:function(t,a,s){"use strict";s.r(a);var n=s(6),e=Object(n.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"async-crash-course"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#async-crash-course","aria-hidden":"true"}},[t._v("#")]),t._v(" Async crash course")]),t._v(" "),s("p",[t._v("New to asynchronous programming in Python? Fear not! This crash course will get you up and running with async and how it impacts building web applications.")]),t._v(" "),s("p",[t._v("If you're already comfortable with async, feel free to skip to the "),s("router-link",{attrs:{to:"/guide/tutorial.html"}},[t._v("tutorial")]),t._v(".")],1),t._v(" "),s("p",[t._v("We'll keep this short, to the point, and focused on using async in Bocadillo. To learn more, see "),s("a",{attrs:{href:"#resources-for-aspiring-experts"}},[t._v("Resources for aspiring experts")]),t._v(" at the bottom of this page.")]),t._v(" "),s("h2",{attrs:{id:"tl-dr"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tl-dr","aria-hidden":"true"}},[t._v("#")]),t._v(" TL;DR")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Defining an async function")]),t._v(": use "),s("code",[t._v("async def")]),t._v(" instead of "),s("code",[t._v("def")]),t._v(".")]),t._v(" "),s("li",[s("strong",[t._v("Calling an async function")]),t._v(": use the "),s("code",[t._v("await")]),t._v(" keyword "),s("em",[t._v("inside an async function")]),t._v(": "),s("code",[t._v("value = await func()")]),t._v(".")]),t._v(" "),s("li",[s("strong",[t._v("CPU-bound operations")]),t._v(": use the "),s("code",[t._v("starlette.concurrency.run_in_threadpool")]),t._v(" helper.")]),t._v(" "),s("li",[s("strong",[t._v("Async libraries")]),t._v(": check out "),s("a",{attrs:{href:"https://www.github.com/timofurrer/awesome-asyncio",target:"_blank",rel:"noopener noreferrer"}},[t._v("awesome-asyncio"),s("OutboundLink")],1),t._v(" or do your own research!")])]),t._v(" "),s("h2",{attrs:{id:"terminology"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#terminology","aria-hidden":"true"}},[t._v("#")]),t._v(" Terminology")]),t._v(" "),s("h3",{attrs:{id:"synchronous-function"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#synchronous-function","aria-hidden":"true"}},[t._v("#")]),t._v(" Synchronous function")]),t._v(" "),s("p",[t._v("Also known as a "),s("em",[t._v("regular function")]),t._v(", this is just a standard Python function defined using the "),s("code",[t._v("def")]),t._v(" syntax:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_attendees")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"John"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mary"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Isabella"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h3",{attrs:{id:"asynchronous-function"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#asynchronous-function","aria-hidden":"true"}},[t._v("#")]),t._v(" Asynchronous function")]),t._v(" "),s("p",[t._v("Also known as a "),s("em",[t._v("coroutine function")]),t._v(", an asynchronous function returns a "),s("a",{attrs:{href:"#coroutine"}},[t._v("coroutine")]),t._v(" and is defined using the "),s("code",[t._v("async def")]),t._v(" syntax:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_attendees")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"John"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mary"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Isabella"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h3",{attrs:{id:"awaitable"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#awaitable","aria-hidden":"true"}},[t._v("#")]),t._v(" Awaitable")]),t._v(" "),s("p",[t._v("An awaitable is an object which can be used in an "),s("code",[t._v("await")]),t._v(' expression. The term "awaitable" is really not much more than a syntax-level definition.')]),t._v(" "),s("h3",{attrs:{id:"coroutine"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#coroutine","aria-hidden":"true"}},[t._v("#")]),t._v(" Coroutine")]),t._v(" "),s("p",[t._v("The return value of an "),s("a",{attrs:{href:"#asynchronous-function"}},[t._v("asynchronous function")]),t._v(" is a particular kind of "),s("a",{attrs:{href:"#awaitable"}},[t._v("awaitable")]),t._v(" known as a "),s("strong",[t._v("coroutine")]),t._v(".")]),t._v(" "),s("p",[t._v("Coroutines are first-class citizens in Python. There's even a built-in type for them! Here, take a look:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_attendees")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"John"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mary"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Isabella"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\ncoro "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_attendees"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("coro"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# <class 'coroutine'>")]),t._v("\n")])])]),s("h2",{attrs:{id:"working-with-coroutines"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#working-with-coroutines","aria-hidden":"true"}},[t._v("#")]),t._v(" Working with coroutines")]),t._v(" "),s("h3",{attrs:{id:"basics"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#basics","aria-hidden":"true"}},[t._v("#")]),t._v(" Basics")]),t._v(" "),s("p",[t._v("Consider the following asynchronous function:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_items")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Getting itemsâ€¦"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("Let's call it:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("items "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("At this point, "),s("code",[t._v("items")]),t._v(" is a "),s("a",{attrs:{href:"#coroutine"}},[t._v("coroutine")]),t._v(":")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# <class 'coroutine'>")]),t._v("\n")])])]),s("p",[t._v('Have you noticed that "Getting itemsâ€¦" has not been printed yet? This is because '),s("code",[t._v("get_items()")]),t._v(" has not even "),s("em",[t._v("run")]),t._v(" yet!")]),t._v(" "),s("p",[t._v('"But then", you say, "how do I run the coroutine and get its result?"')]),t._v(" "),s("p",[t._v("Good question. Here's an inaccurate but pragmatic answer*:")]),t._v(" "),s("ol",[s("li",[t._v("Make sure you are in an "),s("a",{attrs:{href:"#asynchronous-function"}},[t._v("asynchronous function")]),t._v(", i.e. one defined with "),s("code",[t._v("async def")]),t._v(".")]),t._v(" "),s("li",[t._v("Use the "),s("code",[t._v("await")]),t._v(" syntax.")])]),t._v(" "),s("p",[t._v("Here's what it looks like:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# <- example async function")]),t._v("\n    items "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" get_items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# <- call another async function with `await`")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# [1, 2, 3]")]),t._v("\n")])])]),s("p",[s("em",[t._v("*If you're curious to know the more accurate answer, you'll find a lot of useful information in the "),s("a",{attrs:{href:"https://docs.python.org/3/library/asyncio.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("asyncio documentation"),s("OutboundLink")],1),t._v(", e.g. in "),s("a",{attrs:{href:"https://docs.python.org/3/library/asyncio-task.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Coroutines and Tasks"),s("OutboundLink")],1),t._v(".")])]),t._v(" "),s("p",[t._v('"But then", you say, "how am I supposed to run '),s("code",[t._v("main()")]),t._v('?!"')]),t._v(" "),s("p",[t._v("Well, you don't, becauseâ€¦")]),t._v(" "),s("h3",{attrs:{id:"async-is-the-interface"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#async-is-the-interface","aria-hidden":"true"}},[t._v("#")]),t._v(" Async is the interface")]),t._v(" "),s("p",[t._v("As an async web framework, Bocadillo provides an "),s("em",[t._v("asynchronous runtime")]),t._v(" and takes care of running coroutines for you. This allows you to write "),s("code",[t._v("async/await")]),t._v(" code without worrying about who runs it and how.")]),t._v(" "),s("p",[t._v('If that sounds confusing, take a look at the following "Hello, World" application:')]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" bocadillo "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" App"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" configure\n\napp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" App"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconfigure"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n@app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("route"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hello")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello, world!"')]),t._v("\n")])])]),s("p",[t._v("This code doesn't care about how the "),s("code",[t._v("hello")]),t._v(" function is actually run. You don't even need to know anything about "),s("code",[t._v("asyncio")]),t._v(" or how it works.")]),t._v(" "),s("p",[t._v("You just need to use the "),s("code",[t._v("async def")]),t._v(" syntax on the view, and Bocadillo will do the heavy lifting to handle requests in a concurrent fashion. It's magic. âœ¨")]),t._v(" "),s("h3",{attrs:{id:"summary"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#summary","aria-hidden":"true"}},[t._v("#")]),t._v(" Summary")]),t._v(" "),s("p",[t._v("To sum up, here's the gist of what you need to know when working with asynchronous functions and coroutines in Bocadillo:")]),t._v(" "),s("ul",[s("li",[t._v("Define an asynchronous function* using "),s("code",[t._v("async def func(): ...")]),t._v(".")]),t._v(" "),s("li",[t._v("Call an asynchronous function* and get its result using "),s("code",[t._v("value = await func()")]),t._v(".")]),t._v(" "),s("li",[t._v("Bocadillo provides the asynchronous runtime so you can focus on writing async code instead of worrying about how it should run.")])]),t._v(" "),s("p",[s("em",[t._v("*A view, an error handler, a hook, an HTTP middleware callback, etc.")])]),t._v(" "),s("h2",{attrs:{id:"common-patterns"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#common-patterns","aria-hidden":"true"}},[t._v("#")]),t._v(" Common patterns")]),t._v(" "),s("p",[t._v("Here are a few patterns you may find useful while working with async code.")]),t._v(" "),s("h3",{attrs:{id:"executing-cpu-bound-operations"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#executing-cpu-bound-operations","aria-hidden":"true"}},[t._v("#")]),t._v(" Executing CPU-bound operations")]),t._v(" "),s("p",[t._v("In Python, async relies on "),s("em",[t._v("cooperative multitasking")]),t._v(". This means that if a function puts high load on the CPU without using "),s("code",[t._v("await")]),t._v(", other coroutines won't be able to run in the meantime, and you'll lose concurrency.")]),t._v(" "),s("p",[t._v("In a web context in particular, this means that clients need to wait for said function to terminate before they can get their request processed.")]),t._v(" "),s("p",[t._v("To solve this issue, you can use Starlette's "),s("code",[t._v("run_in_threadpool")]),t._v(" helper. It will run the function in a separate thread to ensure that the main thread (where coroutines are run) does not get blocked.")]),t._v(" "),s("p",[t._v("Here's an example of running an expensive CPU-bound operation (sorting random numbers) in a view using "),s("code",[t._v("run_in_threadpool")]),t._v(":")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Not found: /home/travis/build/bocadilloproject/bocadillo/docs/guide/snippets/work_check.py")])])]),s("p",[t._v("Try it out for yourself:")]),t._v(" "),s("ol",[s("li",[t._v("Start the server: "),s("code",[t._v("uvicorn app:app")])]),t._v(" "),s("li",[t._v("Create two new terminal sessions.")]),t._v(" "),s("li",[t._v("In the first terminal, run the following to start sorting 10^7 random numbers:")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:8000/work/7\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[t._v("In the second terminal, run the following while the first terminal is still waiting for a response:")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://localhost:8000/check\n")])])]),s("p",[t._v("You should be able to get "),s("code",[t._v("OK")]),t._v(" responses in the second terminal even though the server is still sorting numbers. This is because the sort happens in a separate thread â€” concurrency is preserved! ðŸŽ‰")]),t._v(" "),s("h3",{attrs:{id:"converting-a-regular-function-to-an-asynchronous-function"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#converting-a-regular-function-to-an-asynchronous-function","aria-hidden":"true"}},[t._v("#")]),t._v(" Converting a regular function to an asynchronous function")]),t._v(" "),s("p",[t._v("If you're given a regular function and you need to convert it to an asynchronous function, you can just write an async wrapper:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" somelib "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" compute\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compute_async")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" compute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("strong",[t._v("Note")]),t._v(": if "),s("code",[t._v("compute")]),t._v(" is CPU-bound, wrapping it in an "),s("code",[t._v("async")]),t._v(" function won't magically prevent it from blocking the main thread â€” you need to use "),s("code",[t._v("run_in_threadpool")]),t._v(" as well:")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" starlette"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("concurrency "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" run_in_threadpool\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" somelib "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" compute\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compute_async")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" run_in_threadpool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("compute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("This can be simplified using "),s("code",[t._v("functools.partial")]),t._v(":")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" functools "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" partial\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" starlette"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("concurrency "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" run_in_threadpool\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" somelib "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" compute\n\ncompute_async "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" partial"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("run_in_threadpool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" compute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"finding-async-libraries-to-replace-synchronous-ones"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#finding-async-libraries-to-replace-synchronous-ones","aria-hidden":"true"}},[t._v("#")]),t._v(" Finding async libraries to replace synchronous ones")]),t._v(" "),s("p",[t._v("One of the caveats associated to async is that "),s("em",[t._v("everything")]),t._v(" needs to be asynchronous (a.k.a. non-blocking), or you may block the main thread and lose concurrency.")]),t._v(" "),s("p",[t._v("For this reason, you will need to use async equivalents of your favorite libraries if they don't support async natively.")]),t._v(" "),s("p",[t._v("For example:")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://github.com/encode/databases",target:"_blank",rel:"noopener noreferrer"}},[t._v("Databases"),s("OutboundLink")],1),t._v(" instead of "),s("a",{attrs:{href:"https://www.sqlalchemy.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("SQLAlchemy"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/encode/requests-async",target:"_blank",rel:"noopener noreferrer"}},[t._v("requests-async"),s("OutboundLink")],1),t._v(" instead of "),s("a",{attrs:{href:"http://docs.python-requests.org/en/master/",target:"_blank",rel:"noopener noreferrer"}},[t._v("requests"),s("OutboundLink")],1),t._v(".")])]),t._v(" "),s("p",[t._v("You can check out "),s("a",{attrs:{href:"https://www.github.com/timofurrer/awesome-asyncio",target:"_blank",rel:"noopener noreferrer"}},[t._v("awesome-asyncio"),s("OutboundLink")],1),t._v(", "),s("a",{attrs:{href:"https://realpython.com/async-io-python/#libraries-that-work-with-asyncawait",target:"_blank",rel:"noopener noreferrer"}},[t._v("Libraries that work with async/await"),s("OutboundLink")],1),t._v(" or do your own research to find async libraries. The ecosystem is ever evolving â€” be on the lookout!")]),t._v(" "),s("h2",{attrs:{id:"resources-for-aspiring-experts"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resources-for-aspiring-experts","aria-hidden":"true"}},[t._v("#")]),t._v(" Resources for aspiring experts")]),t._v(" "),s("p",[t._v("If you're curious to learn more about async in Python â€” the history, the implementation, the ecosystem â€” here are a few resources we think you'll find useful.")]),t._v(" "),s("p",[t._v("Talks:")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://www.youtube.com/watch?v=iG6fr81xHKA",target:"_blank",rel:"noopener noreferrer"}},[t._v("Asynchronous Python for the Complete Beginner"),s("OutboundLink")],1),t._v(" - Miguel Grinberg, PyCon 2017.")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.youtube.com/watch?v=m28fiN9y_r8&t=132s",target:"_blank",rel:"noopener noreferrer"}},[t._v("Async/await in Python 3.5 and why it is awesome"),s("OutboundLink")],1),t._v(" - Yury Selivanov, EuroPython 2016.")])]),t._v(" "),s("p",[t._v("Writings:")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://realpython.com/async-io-python/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Async IO in Python: A Complete Walkthrough"),s("OutboundLink")],1),t._v(" - Real Python.")])]),t._v(" "),s("p",[t._v("Lists:")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://github.com/aio-libs",target:"_blank",rel:"noopener noreferrer"}},[t._v("aio-libs"),s("OutboundLink")],1),t._v(" - The set of asyncio-based libraries built with high quality.")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.github.com/timofurrer/awesome-asyncio",target:"_blank",rel:"noopener noreferrer"}},[t._v("awesome-asyncio"),s("OutboundLink")],1),t._v(" - A curated list of awesome Python asyncio frameworks, libraries, software and resources.")])]),t._v(" "),s("p",[t._v("References:")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://docs.python.org/3/library/asyncio.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Official asyncio documentation"),s("OutboundLink")],1),t._v(" - A library to write concurrent code using the async/await syntax.")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://asgi.readthedocs.io/en/latest/",target:"_blank",rel:"noopener noreferrer"}},[t._v("ASGI"),s("OutboundLink")],1),t._v(" - Asynchronous Server Gateway Interface.")])])])},[],!1,null,null,null);a.default=e.exports}}]);